<template>

        <div class="mt-2">
            <div class="row head-container">
                <div class="col-md-6 col-sm-12">
                    <div class="input-container">
                        <i class="fa fa-search"></i>
                        <input type="text" placeholder="Search"  v-model="searchTerm" @input="filterItems">
                    </div>
                </div>
                <div class="col-md-6 col-sm-12" style="display: flex; align-items: center; justify-content: flex-end; gap: 20px;">
                    <div class="select-dropdown">
                    <!-- Second dropdown -->
                    <select id="sort-select" class="form-control" style="text-align: center;"  v-model="session"  @change="filterItems">
                        <option value="0" disabled selected>Select Attendace Type</option>
                        <option :value="1" v-if="attendance_count >= 1">Morning (Log in)</option>
                        <option :value="2" v-if="attendance_count >= 2">Morning (Log out)</option>
                        <option :value="3" v-if="attendance_count >= 3">Afternoon (Log in)</option>
                        <option :value="4" v-if="attendance_count >= 4">Afternoon (Log out)</option>
                    </select>
                    </div>
                    <div class="select-dropdown d-flex justify-content-end">
                        <select id="sort-select" class="form-control" style="text-align: center;" v-model="college_data_input" @change="filterItems">
                            <option value="0" disabled selected >Select College</option>
                            <option v-for="college in this.college_list" :value="college.id"> {{ college.college }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="fas fa-list mt-2"></i> Attendance Record</h4>
                <div class="student-buttons d-flex">

                    <div class="btn-group" role="group">
                    <button class="btn me-2" @click="printTable">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn me-2" @click="downloadTable">
                        <i class="fas fa-download"></i> Download
                    </button>
                    </div>
                </div>
            </div>
        </div>
        <div id="table-container" style="height: 800vh !important; max-height: 80vh;">

                <div class="scroll-pane" id="table-list" style="height: 70vh !important; max-height: 70vh;" >
                    <h5 id="Eventtitle"> Event: <b>{{ this.event.event_title }}</b></h5>
                    <p>Date: <b>{{ this.event.event_date }}</b> </p>
                    <table>
                        <thead>
                            <tr>
                                <th class="sortable-header" style="width: 10%;">Student ID</th>
                                <th class="sortable-header">Student Name</th>
                                <th class="sortable-header">College</th>
                                <!-- <th class="sortable-header" style="width: 5%;"> </th> -->
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="attendance in paginatedData" :key="attendance.user_id">
                                <td>{{ attendance.user_id }}</td>
                                <td>{{ attendance.user_profile.first_name }}</td>
                                <td>{{ attendance.user_profile.college.college}}</td>

                            </tr>
                        </tbody>
                    </table>
            </div>
            <ul class="pagination justify-content-center mt-2">
                    <li class="page-item" :class="{ disabled: currentPage === 1 }">
                        <a class="page-link" href="#" tabindex="-1" aria-disabled="true" @click.prevent="prevPage">Previous</a>
                    </li>
                    <li v-for="page in pageRange" :key="page" class="page-item" :class="{ active: currentPage === page }">
                        <a class="page-link" href="#" @click.prevent="gotoPage(page)">{{ page }}</a>
                    </li>
                    <li class="page-item" :class="{ disabled: currentPage === totalPages }">
                        <a class="page-link" href="#" @click.prevent="nextPage">Next</a>
                    </li>
                </ul>
        </div>

</template>


<script>
import { converTime } from "../Functions/TimeConverter.js";
import { convertDate } from "../Functions/DateConverter.js";

export default {
  props: ['organization_id', 'event_id'],
  data() {
    return {
        attendance: [],
        event: {
            event_title: '',
            event_date: '',
        },
        currentPage: 1,
        itemsPerPage: 10,
        attendance_count: 0,
        session: 0,
        searchTerm: '',
        filtered_attendance: [],
        college_list: [],
        college_data_input: 0,
    };
  },
  computed: {
    totalPages() {
        return Math.ceil(this.attendance.length / this.itemsPerPage);
    },
    pageRange() {
        const start = Math.max(1, this.currentPage - 5);
        const end = Math.min(this.totalPages, this.currentPage + 5);
        const range = [];

        if (start > 1) {
            range.push(1);
            if (start > 2) {
            range.push("...");
            }
        }

        for (let i = start; i <= end; i++) {
            range.push(i);
        }

        if (end < this.totalPages) {
            if (end < this.totalPages - 1) {
            range.push("...");
            }
            range.push(this.totalPages);
        }

        return range;
    },
    paginatedData() {
        const start = (this.currentPage - 1) * this.itemsPerPage;
        return this.filtered_attendance.slice(start, start + this.itemsPerPage);
    },
    hasEllipsisBefore() {
        return this.currentPage > 3 && this.totalPages > 5;
    },

    hasEllipsisAfter() {
        return this.currentPage < this.totalPages - 2 && this.totalPages > 5;
    },
    ellipsisRange() {
        const range = [];
        const start = Math.max(this.currentPage - 2, 1);
        const end = Math.min(start + 4, this.totalPages);

        if (this.hasEllipsisBefore) {
            range.push(this.ellipsisBefore);
        }

        for (let i = start; i <= end; i++) {
            range.push(i);
        }

        if (end < this.totalPages) {
            if (end < this.totalPages - 1) {
            range.push(this.ellipsisAfter);
            }
            range.push(this.totalPages);
        }

        // If there are more than 5 page numbers, remove the ones in the middle
        if (range.length > 5) {
            range.splice(3, range.length - 5);
        }

        return range;
    },
    ellipsisBefore() {
        return Math.max(this.currentPage - 5, 1);
    },
    ellipsisAfter() {
        return Math.min(this.currentPage + 5, this.totalPages);
    },
    },

  mounted() {
    this.fetchData();
    this.showCollege();
  },
    methods:{
    showCollege(){
        axios.get(`/view_college`)
            .then(response => {
                this.college_list = response.data;
                // console.log(response.data)
            })
            .catch(error => {
                console.log(error)
            });
    },
    filterItems() {
        let filteredBySearch = this.attendance;
        // if (this.searchTerm) {
        //     const searchTermLower = this.searchTerm.toLowerCase();
        //     filteredBySearch = filteredBySearch.filter(item =>
        //         item.user_profile.first_name.toLowerCase().includes(searchTermLower) ||
        //         item.user_id.toString().includes(this.searchTerm)
        //     );
        // }
        if (this.searchTerm) {
                const searchTermLower = this.searchTerm.toLowerCase();
                filteredBySearch = filteredBySearch.filter(item => (item.user_profile.first_name +''+ item.user_profile.last_name).toLowerCase().includes(searchTermLower) ||
                        item.user_id.toString().includes(this.searchTerm)
                );
            }
    
        // Filter based on filterStatus from select option
        let filteredByStatus = this.attendance;
        if (this.session) {
            filteredByStatus = filteredByStatus.filter(item =>
                item.session.toString().includes(this.session)
            );
        }

        let filteredByCollege = this.attendance;
        if (this.college_data_input !== undefined && this.college_data_input !== null) {
            filteredByCollege = filteredByCollege.filter(item =>
                item.college_id === parseInt(this.college_data_input, 10)
            );
        }


        // Merge the results of all three filters (independently applied)
        this.filtered_attendance = filteredBySearch.filter(item =>
            filteredByStatus.includes(item) && filteredByCollege.includes(item)
        );
        console.log(this.filtered_attendance)
        // this.filtered_attendance = filteredBySearch

    },
        fetchData(){
        axios.get(`/attendance/list/${this.organization_id}/${this.event_id}`)
            .then(response => {
                this.filtered_attendance = [],
                console.log(response.data)
                    const data = response.data;
                        data.forEach(item => {
                            // console.log(item);
                            item['events']['start_date'] = convertDate(item['events']['start_date']);
                            this.event.event_title = item['events']['name'];
                            this.event.event_date = item['events']['start_date'];
                            this.attendance_count = item.events.attendance_count;
                        });
                        this.attendance = response.data;
                        this.filtered_attendance = this.attendance;
                        console.log(this.attendance);
                    //   this.attendance.forEach(element => {
                    //     this.attendance_list.push({
                    //       student_id : element.user_id,
                    //       student_name: element.user.name,
                    //       college: element.college.college,
                    //     })
                    //   });

            })
            .catch(error => {

            });
    },
    nextPage() {
        if (this.currentPage < this.totalPages) {
        this.currentPage++;
        }
    },

    gotoPage(page) {
        if (page === "...") {
            if (this.currentPage > this.totalPages / 2) {
            this.currentPage = this.totalPages;
            } else {
            this.currentPage = 1;
            }
        } else {
            this.currentPage = page;
        }
    },
    printTable() {
  // Create a hidden iframe for printing
  const iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  document.body.appendChild(iframe);

  // Generate the printable HTML document in the iframe
  const iframeDoc = iframe.contentWindow.document;
  iframeDoc.open();
  iframeDoc.write(`
      <html>
      <head>
          <title>Print</title>
          <!-- Include Bootstrap stylesheet link -->
          <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
      </head>
      <body>
          <!-- Add a title before the table -->
          <h2>Attendance Record</h2>
          <br>
          <h5 id="Eventtitle"> Event: <b>${this.event.event_title}</b></h5>
          <p>Date: <b>${this.event.event_date}</b></p>

          <!-- Add Bootstrap table classes -->
          <table class="table table-bordered table-striped">
              <thead>
                  <tr>
                      <th>Student ID</th>
                      <th>Student Name</th>
                      <th>College</th>
                  </tr>
              </thead>
              <tbody>
                  ${this.generateTableRows(this.filtered_attendance)}
              </tbody>
          </table>
      </body>
      </html>
  `);
  iframeDoc.close();

  // Print the iframe content
  iframe.contentWindow.focus();
  iframe.contentWindow.print();

  // Remove the iframe after printing
  setTimeout(() => {
      document.body.removeChild(iframe);
  }, 1000);
},

generateTableRows(data) {
  let rows = '';
  data.forEach(item => {
      rows += `
          <tr>
              <td>${item.user_id}</td>
              <td>${item.user.name}</td>
              <td>${item.college.college} </td>
          </tr>
      `;
  });
  return rows;
},
downloadTable() {
  // Get the table data specifically from attendance
  const tableData = this.getAttendanceTableData();

  // Create a workbook
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(tableData);
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

  // Save the workbook as an Excel file
  XLSX.writeFile(wb, 'AttendanceRecord.xlsx');
},

getAttendanceTableData() {
  // Get a reference to the attendance data
  const data = this.attendance;

  // Initialize an array to store the table data
  const tableData = [];

  // Iterate through the attendance data
  for (let i = 0; i < data.length; i++) {
    const rowData = [];

    // Add the desired data fields to the rowData array
    rowData.push(data[i].student_id);
    rowData.push(data[i].user.name);
    rowData.push(data[i].user.name);
    rowData.push(data[i].college.college);

    // Push the row data to the tableData array
    tableData.push(rowData);
  }

  // Return the table data
  return tableData;
},
    },
}

</script>
